<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <title>Kassa oynasi</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
    <style>
        table { border-collapse: collapse; width: 100%; }
        th, td { padding: 8px; text-align: left; border: 1px solid #ddd; }
        th { background: #f2f2f2; }
        #cart-message { margin-top: 10px; }
    </style>
</head>
<body>

<h2>Kassa oynasi</h2>

<!-- Qidiruv formasi -->
<input type="text" id="search-input" placeholder="Qidiruv (nom yoki barcode)" autocomplete="off">

<br><br>

<!-- Mahsulotlar jadvali DIV orqali -->
<div id="products-table">
    {% include "market/_products_table.html" %}
</div>

<!-- Savat bo‘limi -->
<div id="cart-area">
    {% include "market/_cart_partial.html" %}
</div>
<div id="cart-message"></div>

<!-- PDF tugmasi -->
<button type="button" onclick="generatePDF()">Chekni PDFga saqlash</button>
<a href="{% url 'sales_list' %}">Cheklar tarixi</a>

<script>
$(document).ready(function(){
    // AJAX qidiruv
    $('#search-input').on('input', function(){
        var query = $(this).val();
        $.ajax({
            url: "{% url 'kassa' %}",
            data: {'q': query},
            headers: {'X-Requested-With': 'XMLHttpRequest'},
            success: function(data){
                $('#products-table').html(data.products_html);
            }
        });
    });

    // AJAX orqali savatga qo'shish va boshqa amallar
    $(document).on('submit', '.cart-add-form, .cart-remove-form, #cart-clear-form, #cart-checkout-form', function(e){
        e.preventDefault();
        var $form = $(this);
        $.ajax({
            type: $form.attr('method'),
            url: $form.attr('action'),
            data: $form.serialize(),
            headers: {'X-CSRFToken': $form.find('input[name="csrfmiddlewaretoken"]').val()},
            success: function(data){
                $('#cart-area').html(data.cart_html);
                if(data.message){
                    $('#cart-message').html('<b style="color:green;">' + data.message + '</b>');
                } else {
                    $('#cart-message').html('');
                }
            },
            error: function(xhr){
                $('#cart-message').html('<b style="color:red;">Xatolik yuz berdi!</b>');
                console.error(xhr.responseText);
            }
        });
    });
    // AJAX orqali mahsulot miqdorini o'zgartirish
    $(document).on('click', '.update-cart', function(e){
        e.preventDefault();
        var productId = $(this).data('id');
        var action = $(this).data('action');
        var csrftoken = $('[name="csrfmiddlewaretoken"]').first().val();

        $.ajax({
            type: 'POST',
            url: `/cart/update/${productId}/`,
            data: { 'action': action },
            headers: {'X-CSRFToken': csrftoken},
            success: function(data){
                $('#cart-area').html(data.cart_html);
                $('#cart-message').html('<b style="color:green;">' + data.message + '</b>');
            },
            error: function(){
                $('#cart-message').html('<b style="color:red;">Xatolik yuz berdi!</b>');
            }
        });
    });

});

// PDFga saqlash funksiyasi (o‘zgarmaydi)
function generatePDF() {
    var items = [
        ['Mahsulot', 'Miqdori', 'Jami'],
        {% for item in cart_items %}
        [
            "{{ item.product.desc|escapejs }}",
            "{{ item.quantity }}",
            "{{ item.item_total }}"
        ]{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    var docDefinition = {
        content: [
            { text: 'Chek', style: 'header', alignment: 'center' },
            {
                table: {
                    headerRows: 1,
                    body: items
                }
            },
            { text: 'Umumiy summa: {{ total }}', style: 'total', margin: [0, 10, 0, 0] }
        ],
        styles: {
            header: { fontSize: 16, bold: true, margin: [0, 0, 0, 10] },
            total: { fontSize: 14, bold: true }
        }
    };
    pdfMake.createPdf(docDefinition).download('check.pdf');
}
</script>
<br><br>
<a href="{% url 'statistics' %}">Statistika va hisobotlar</a>
</body>
</html>
