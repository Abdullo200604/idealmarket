{% extends "market/base.html" %}

{% block title %}Kassa oynasi{% endblock %}

{% block content %}
<div class="container my-3">
    <div class="main-card shadow-sm">
        <h2 class="mb-3 text-center">Kassa oynasi</h2>
        <input type="text" id="search-input" class="form-control mb-3" placeholder="Qidiruv (nom yoki barcode)" autocomplete="off" style="max-width:400px; margin:auto;">
        <!-- Mahsulotlar jadvali scroll bilan -->
        <div class="table-responsive mb-3" style="max-height: 270px;">
            <div id="products-table">
                {% include "market/_products_table.html" %}
            </div>
        </div>
        <hr>
        <div id="cart-area">
            {% include "market/_cart_partial.html" %}
        </div>
        <div id="cart-message" class="mt-2" style="min-height:24px;"></div>
        <div class="d-flex flex-wrap gap-2 mt-3 justify-content-center">
            <button type="button" onclick="generatePDF()" class="btn btn-outline-info">Chekni PDFga saqlash</button>
            <a href="{% url 'sales_list' %}" class="btn btn-outline-secondary">Cheklar tarixi</a>
            <a href="{% url 'statistics' %}" class="btn btn-outline-primary">Statistika va hisobotlar</a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function(){
    $('#search-input').on('input', function(){
        var query = $(this).val();
        $.ajax({
            url: "{% url 'kassa' %}",
            data: {'q': query},
            headers: {'X-Requested-With': 'XMLHttpRequest'},
            success: function(data){
                $('#products-table').html(data.products_html);
            }
        });
    });
    $(document).on('submit', '.cart-add-form, .cart-remove-form, #cart-clear-form, #cart-checkout-form, .update-cart', function(e){
        e.preventDefault();
        var $form = $(this);
        $.ajax({
            type: $form.attr('method'),
            url: $form.attr('action'),
            data: $form.serialize(),
            headers: {'X-CSRFToken': $form.find('input[name="csrfmiddlewaretoken"]').val()},
            success: function(data){
                $('#cart-area').replaceWith(data.cart_html);
                $('#cart-message').html(data.message ? '<b style="color:green;">' + data.message + '</b>' : '');
            },
            error: function(xhr){
                let msg = 'Xatolik yuz berdi!';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    msg = xhr.responseJSON.message;
                }
                $('#cart-message').html('<b style="color:red;">' + msg + '</b>');
            }
        });
    });
});
function generatePDF() {
    var items = [
        ['Mahsulot', 'Miqdori', 'Jami'],
        {% for item in cart_items %}
        [
            "{{ item.product.desc|escapejs }}",
            "{{ item.quantity }}",
            "{{ item.item_total }}"
        ]{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    var docDefinition = {
        content: [
            { text: 'Chek', style: 'header', alignment: 'center' },
            {
                table: {
                    headerRows: 1,
                    body: items
                }
            },
            { text: 'Umumiy summa: {{ total }}', style: 'total', margin: [0, 10, 0, 0] }
        ],
        styles: {
            header: { fontSize: 16, bold: true, margin: [0, 0, 0, 10] },
            total: { fontSize: 14, bold: true }
        }
    };
    pdfMake.createPdf(docDefinition).download('check.pdf');
}
</script>
{% endblock %}
