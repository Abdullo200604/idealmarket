<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <title>Kassa oynasi</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
    <style>
        body { background: #f9fafc; }
        .main-card { margin: 35px auto; padding: 32px; max-width: 950px; background: #fff; border-radius: 18px; box-shadow: 0 4px 20px #ececec; }
        .logout-button { position: absolute; top: 18px; right: 32px; background: #dc3545; color: white; padding: 8px 16px; border-radius: 6px; font-weight: bold; text-decoration: none;}
        .logout-button:hover { background: #c82333;}
    </style>
</head>
<body>
<a href="{% url 'logout' %}" class="logout-button">Chiqish</a>
<div class="main-card">
    <h2>Kassa oynasi</h2>
    <!-- Qidiruv formasi -->
    <input type="text" id="search-input" class="form-control mb-3" placeholder="Qidiruv (nom yoki barcode)" autocomplete="off" style="max-width:350px;">
    <!-- Mahsulotlar jadvali (AJAX orqali yuklanadi) -->
    <div id="products-table">
        {% include "market/ex.html" %}
    </div>
    <hr>
    <!-- Savat boâ€˜limi -->
    <div id="cart-area">
        {% include "market/_cart_partial.html" %}
    </div>
    <div id="cart-message"></div>
    <button type="button" onclick="generatePDF()" class="btn btn-outline-info mt-3">Chekni PDFga saqlash</button>
    <a href="{% url 'sales_list' %}" class="btn btn-outline-secondary mt-3">Cheklar tarixi</a>
    <a href="{% url 'statistics' %}" class="btn btn-outline-primary mt-3 ms-2">Statistika va hisobotlar</a>
</div>
<script>
$(document).ready(function(){
    // AJAX qidiruv
    $('#search-input').on('input', function(){
        var query = $(this).val();
        $.ajax({
            url: "{% url 'kassa' %}",
            data: {'q': query},
            headers: {'X-Requested-With': 'XMLHttpRequest'},
            success: function(data){
                $('#products-table').html(data.products_html);
            }
        });
    });

    // AJAX orqali savatga qo'shish va boshqa amallar
    $(document).on('submit', '.cart-add-form, .cart-remove-form, #cart-clear-form, #cart-checkout-form', function(e){
        e.preventDefault();
        var $form = $(this);
        $.ajax({
            type: $form.attr('method'),
            url: $form.attr('action'),
            data: $form.serialize(),
            headers: {'X-CSRFToken': $form.find('input[name="csrfmiddlewaretoken"]').val()},
            success: function(data){
                $('#cart-area').html(data.cart_html);
                if(data.message){
                    $('#cart-message').html('<b style="color:green;">' + data.message + '</b>');
                } else {
                    $('#cart-message').html('');
                }
            },
            error: function(xhr){
                $('#cart-message').html('<b style="color:red;">Xatolik yuz berdi!</b>');
                console.error(xhr.responseText);
            }
        });
    });
    // AJAX orqali mahsulot miqdorini o'zgartirish
    $(document).on('click', '.update-cart', function(e){
        e.preventDefault();
        var productId = $(this).data('id');
        var action = $(this).data('action');
        var csrftoken = $('[name="csrfmiddlewaretoken"]').first().val();

        $.ajax({
            type: 'POST',
            url: `/cart/update/${productId}/`,
            data: { 'action': action },
            headers: {'X-CSRFToken': csrftoken},
            success: function(data){
                $('#cart-area').html(data.cart_html);
                $('#cart-message').html('<b style="color:green;">' + data.message + '</b>');
            },
            error: function(){
                $('#cart-message').html('<b style="color:red;">Xatolik yuz berdi!</b>');
            }
        });
    });
});

// PDFga saqlash funksiyasi
function generatePDF() {
    var items = [
        ['Mahsulot', 'Miqdori', 'Jami'],
        {% for item in cart_items %}
        [
            "{{ item.product.desc|escapejs }}",
            "{{ item.quantity }}",
            "{{ item.item_total }}"
        ]{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    var docDefinition = {
        content: [
            { text: 'Chek', style: 'header', alignment: 'center' },
            {
                table: {
                    headerRows: 1,
                    body: items
                }
            },
            { text: 'Umumiy summa: {{ total }}', style: 'total', margin: [0, 10, 0, 0] }
        ],
        styles: {
            header: { fontSize: 16, bold: true, margin: [0, 0, 0, 10] },
            total: { fontSize: 14, bold: true }
        }
    };
    pdfMake.createPdf(docDefinition).download('check.pdf');
}
</script>
</body>
</html>
